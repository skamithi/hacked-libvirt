From: Ubuntu Developers <ubuntu-devel-discuss@lists.ubuntu.com>
Date: Fri, 7 Aug 2015 17:07:53 -0400
Subject: ubuntu-xend-probe

===================================================================
---
 src/libxl/libxl_driver.c | 21 +++++++++++++--------
 src/xen/xen_driver.c     | 22 ++++++++++++++++++----
 2 files changed, 31 insertions(+), 12 deletions(-)

diff --git a/src/libxl/libxl_driver.c b/src/libxl/libxl_driver.c
index c297d12..6cede83 100644
--- a/src/libxl/libxl_driver.c
+++ b/src/libxl/libxl_driver.c
@@ -429,6 +429,7 @@ libxlDriverShouldLoad(bool privileged)
     bool ret = false;
     int status;
     char *output = NULL;
+    virCommandPtr cmd;
 
     /* Don't load if non-root */
     if (!privileged) {
@@ -458,19 +459,23 @@ libxlDriverShouldLoad(bool privileged)
     }
 
     /* Don't load if legacy xen toolstack (xend) is in use */
-    if (virFileExists("/usr/sbin/xend")) {
-        virCommandPtr cmd;
+    cmd = virCommandNewArgList("/usr/lib/xen-common/bin/xen-toolstack", NULL);
+    virCommandSetOutputBuffer(cmd, &output);
+    if (virCommandRun(cmd, &status) == 0 && status == 0) {
+        int i, j;
 
-        cmd = virCommandNewArgList("/usr/sbin/xend", "status", NULL);
-        if (virCommandRun(cmd, NULL) == 0) {
+        for (i = 0, j = 0; output[i] != '\0'; i++)
+            if (output[i] == '/')
+                j = i + 1;
+
+        if (output[j] == 'x' && output[j+1] == 'l') {
+            ret = true;
+        } else {
             VIR_INFO("Legacy xen tool stack seems to be in use, disabling "
                      "libxenlight driver.");
-        } else {
-            ret = true;
         }
+        VIR_FREE(output);
         virCommandFree(cmd);
-    } else {
-        ret = true;
     }
 
     return ret;
diff --git a/src/xen/xen_driver.c b/src/xen/xen_driver.c
index da9e6f4..4c30911 100644
--- a/src/xen/xen_driver.c
+++ b/src/xen/xen_driver.c
@@ -310,22 +310,36 @@ xenUnifiedProbe(void)
 }
 
 #ifdef WITH_LIBXL
+#define TOOLSTACK_PATH "/usr/lib/xen-common/bin/xen-toolstack"
 static bool
 xenUnifiedXendProbe(void)
 {
     bool ret = false;
+    char *output;
 
-    if (virFileExists("/usr/sbin/xend")) {
+    if (virFileExists(TOOLSTACK_PATH)) {
         virCommandPtr cmd;
+        int status;
 
-        cmd = virCommandNewArgList("/usr/sbin/xend", "status", NULL);
-        if (virCommandRun(cmd, NULL) == 0)
-            ret = true;
+        cmd = virCommandNewArgList(TOOLSTACK_PATH,  NULL);
+        virCommandSetOutputBuffer(cmd, &output);
+        if (virCommandRun(cmd, &status) == 0 && status == 0) {
+            int i, j;
+
+            for (i = 0, j = 0; output[i] != '\0'; i++)
+                if (output[i] == '/')
+                    j = i + 1;
+
+            if (output[j] == 'x' && output[j+1] == 'm')
+                ret = true;
+        }
+        VIR_FREE(output);
         virCommandFree(cmd);
     }
 
     return ret;
 }
+#undef TOOLSTACK_PATH
 #endif
 
 
